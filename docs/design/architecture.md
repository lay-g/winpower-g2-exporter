# WinPower G2 Exporter 架构设计

## 项目概述

WinPower G2 Exporter 是一个用于采集 WinPower 设备数据、计算能耗并以 Prometheus 指标形式导出的 Go 应用程序。项目采用模块化设计，遵循简单、可维护、易测试的原则。

## 设计原则

- **简单优先**：减少不必要的功能与耦合，默认关闭可选特性
- **明确边界**：每个模块只对外暴露少量、稳定的接口
- **可替换**：关键模块通过接口抽象，易于替换实现
- **易测试**：面向接口编程，模块均可用 Mock 隔离测试
- **可观察**：统一日志与指标采集入口，方便排障与性能分析

## 项目目录结构

项目采用标准的 Go 项目布局，按照功能模块清晰组织：

```
winpower-g2-exporter/
├── cmd/                         # 应用程序入口点
├── config/                      # 配置文件示例
├── internal/                    # 内部实现包（不对外暴露）
│   ├── cmd/                     # 命令行工具实现
│   ├── pkgs/                    # 内部公共包
│   ├── config/                  # 配置管理模块
│   ├── storage/                 # 存储模块
│   ├── winpower/                # WinPower模块（认证和数据采集）
│   ├── collector/               # Collector模块（数据协调）
│   ├── energy/                  # 电能计算模块
│   ├── metrics/                 # 指标模块
│   ├── server/                  # HTTP服务模块
│   └── scheduler/               # 调度器模块
├── docs/                        # 项目文档
│   ├── design/                  # 设计文档
│   ├── protocol/                # 协议文档
│   └── examples/                # 使用示例
├── tests/                       # 测试文件
│   ├── integration/             # 集成测试
│   ├── fixtures/                # 测试数据
│   └── mocks/                   # Mock对象
├── scripts/                     # 构建和部署脚本
├── deployments/                 # 部署配置
├── Dockerfile                   # Docker构建文件
├── Makefile                     # 构建和开发脚本
├── go.mod                       # Go模块定义
├── go.sum                       # Go模块校验和
├── README.md                    # 项目说明文档
└── LICENSE                      # 许可证文件
```

## 核心模块

项目由以下核心模块组成，每个模块负责特定的功能领域：

### 配置管理 (config)
统一配置加载、验证和管理，支持文件、环境变量、命令行参数等多种配置源。

### 日志模块 (log)
提供统一的结构化日志接口，支持多级别日志记录和格式化输出。

### WinPower 模块 (winpower)
负责与 WinPower 系统的认证管理和设备数据采集，提供原始设备数据。

### 存储模块 (storage)
持久化电能累计值与必要的元数据，支持可替换的存储实现。

### 电能计算模块 (energy)
基于功率读数进行积分计算，实现电能的累计和查询功能。

### 采集器模块 (collector)
协调数据采集流程，作为数据处理的中心枢纽，触发电能计算。

### 指标模块 (metrics)
管理 Prometheus 指标注册表，提供 `/metrics` HTTP 端点。

### 服务模块 (server)
HTTP 服务层，提供路由、中间件和端点暴露功能。

### 调度器模块 (scheduler)
定时任务调度，按固定周期触发数据采集和处理流程。

## 数据流概览

系统采用定时采集模式，数据流向如下：

1. **采集触发**：调度器按固定周期触发数据采集
2. **数据获取**：从 WinPower 系统采集设备数据
3. **电能计算**：基于功率数据进行电能累计计算
4. **数据持久化**：将计算结果存储到持久化层
5. **指标更新**：更新 Prometheus 指标注册表
6. **指标暴露**：通过 HTTP 端点暴露指标数据

## 关键特性

### 统一采集入口
所有数据采集通过统一的采集器模块进行，确保数据一致性和可追溯性。

### 定时调度机制
采用固定周期调度，与 Prometheus 抓取间隔解耦，确保数据采集的独立性。

### 可观察性
提供完整的日志记录和指标监控，便于系统运行状态监控和问题排查。

### 模块化设计
各模块职责清晰，通过接口定义交互，便于测试和维护。

## 技术栈

- **语言**: Go 1.25+
- **框架**: Gin (HTTP 服务)
- **日志**: zap (高性能结构化日志)
- **指标**: Prometheus
- **测试**: Go 标准测试库 + Mock
- **开发方法**: 测试驱动开发 (TDD)

## 部署架构

系统设计为独立运行的 exporter 进程，通过 HTTP 端点提供服务：

- **指标端点**: `/metrics` - 暴露 Prometheus 格式的指标数据
- **健康检查**: `/health` - 提供服务健康状态检查
- **调试端点**: `/debug/pprof` - 可选的性能分析端点

生产环境建议使用反向代理进行 TLS 终结和负载均衡。