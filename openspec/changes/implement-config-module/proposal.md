# 实现 Config 模块

## Why

当前项目的配置管理存在以下问题：
1. **配置分散**：各模块（storage、winpower、energy等）都有独立的配置实现，缺乏统一管理
2. **缺少环境变量支持**：当前配置主要依赖代码默认值，不便于容器化部署和运维配置
3. **验证不一致**：各模块的配置验证逻辑不统一，错误处理不规范
4. **维护困难**：缺少统一的配置加载流程，新增配置项时需要修改多处代码
5. **测试覆盖不足**：配置相关测试分散且不完整，难以保证配置系统的可靠性

通过实现统一的配置管理模块，可以：
- 提供一致的配置接口和加载流程
- 支持YAML文件和环境变量的灵活配置方式
- 统一配置验证和错误处理机制
- 提高配置系统的可测试性和可维护性
- 支持配置热重载和监控功能

## 概述

根据 `docs/design/config.md` 的设计文档，实现统一的配置管理模块，提供模块化配置加载、验证和环境变量绑定功能。

## What Changes

### 新增功能
1. **统一配置加载器** (`internal/pkgs/config`)
   - 实现Config和Provider接口
   - 支持YAML文件和环境变量加载
   - 提供配置验证和缓存功能

2. **配置文件监控**
   - 支持配置文件热重载
   - 提供配置变更通知机制

3. **增强的配置验证**
   - 统一的验证接口和错误处理
   - 支持复杂验证规则和依赖检查

### 修改现有模块
1. **重构各模块配置结构**
   - storage: 实现Config接口，添加环境变量支持
   - winpower: 保持现有验证逻辑，统一接口
   - energy: 添加环境变量支持，统一接口
   - server: 添加环境变量支持，统一接口
   - scheduler: 添加环境变量支持，统一接口

2. **更新主函数配置加载流程**
   - 使用统一的配置加载器
   - 按依赖顺序加载各模块配置

### 保持不变
1. 现有配置文件格式保持兼容
2. 各模块配置的核心功能不变
3. 现有的API接口保持不变

## 设计原则

- **模块化**：每个模块拥有独立的配置结构和管理逻辑
- **解耦**：模块间通过配置接口传递，避免直接依赖
- **一致性**：统一的配置加载模式和验证机制
- **向后兼容**：保持现有YAML配置文件格式不变
- **TDD**：采用测试驱动开发，优先编写测试用例

## 实现范围

1. **配置加载工具包** (`internal/pkgs/config`)
   - 统一配置接口定义
   - YAML文件解析
   - 环境变量绑定
   - 配置验证工具

2. **模块配置重构**
   - 重构现有模块配置以符合新的统一接口
   - 保持向后兼容性
   - 增强配置验证能力

3. **配置加载流程**
   - 统一的配置初始化流程
   - 错误处理和验证
   - 敏感信息脱敏

## 技术要求

- Go 1.25+
- 使用 viper 库进行配置管理
- 支持YAML配置文件和环境变量
- 完整的单元测试和集成测试
- 遵循项目TDD规范

## Impact

### 受影响的规格
- **config-loader-module** (新增能力) - 统一配置加载器
- **module-config-updates** (修改能力) - 现有模块配置适配
- **tdd-testing-strategy** (新增能力) - 测试驱动开发策略

### 受影响的代码
- `internal/pkgs/config/` (新增配置加载工具包)
- `internal/storage/config.go` (重构为统一接口)
- `internal/winpower/config.go` (重构为统一接口)
- `internal/energy/config.go` (重构为统一接口)
- `internal/server/config.go` (重构为统一接口)
- `internal/scheduler/config.go` (重构为统一接口)
- `cmd/exporter/` (更新配置初始化流程)

### 依赖关系
- 需要viper库作为配置管理依赖
- 需要fsnotify库用于配置文件监控
- 各模块配置依赖于新的config包

### 向后兼容性
- 现有配置文件格式保持不变
- 现有环境变量命名规则保持不变
- 各模块配置的核心功能保持不变