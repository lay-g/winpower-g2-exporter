# implement-winpower-module 实现任务清单

## 阶段一：基础结构搭建

### 1.1 创建模块目录结构
- [x] 创建 `internal/winpower/` 目录及基础文件结构
- [x] 创建测试目录 `internal/winpower/mocks/` 和 `internal/winpower/fixtures/`
- [x] 验证目录结构符合项目规范，go.mod 能正确识别模块

**验证标准**：目录结构清晰，符合 Go 项目规范，模块可以被正确导入

### 1.2 定义核心接口和数据结构
- [x] 定义 `WinPowerClient` 接口（CollectDeviceData, GetConnectionStatus, GetLastCollectionTime）
- [x] 定义 `ParsedDeviceData` 和相关数据结构
- [x] 定义错误类型和常量
- [x] 通过编译检查，接口设计文档完成

**验证标准**：接口设计清晰，数据结构完整，通过 go build 编译检查

### 1.3 实现配置管理
- [x] 实现 `Config` 结构体，包含 BaseURL, Username, Password, Timeout, SkipSSLVerify, RefreshThreshold
- [x] 实现 `DefaultConfig()` 函数提供默认值
- [x] 实现 `Validate()` 方法，实现 ConfigValidator 接口
- [x] 配置加载验证通过，默认值正确

**验证标准**：配置验证功能正常，默认值合理，集成到主配置系统

## 阶段二：HTTP 通信层

### 2.1 实现 HTTP 客户端
- [x] 实现 `HTTPClient` 结构体，封装 `http.Client`
- [x] 支持 GET/POST 请求和 SSL 配置（跳过验证选项）
- [x] 实现连接复用和超时策略
- [x] 编写单元测试：正常 HTTP 请求、HTTPS 证书验证、跳过 SSL、超时处理、错误响应
- [x] 所有单元测试通过，集成测试验证通信正常

**验证标准**：HTTP 客户端功能完整，支持各种网络场景，测试覆盖充分

### 2.2 实现 Token 管理器
- [x] 实现 `TokenManager` 结构体，支持登录、缓存和自动刷新
- [x] 实现并发安全的 Token 访问（使用读写锁）
- [x] 实现智能刷新策略（过期前阈值刷新）
- [x] 编写单元测试：首次登录、Token 缓存、过期检测、自动刷新、认证失败、并发安全
- [x] 所有单元测试通过，Mock 服务器验证认证流程

**验证标准**：Token 管理功能稳定，并发安全，自动刷新机制正常

## 阶段三：数据解析层

### 3.1 实现响应解析器
- [x] 实现 `DataParser` 结构体，解析 WinPower API 响应
- [x] 实现 JSON 响应解析和数据类型转换
- [x] 实现设备基本信息提取和实时数据转换
- [x] 编写单元测试：JSON 解析、数据提取、类型转换、字段缺失、格式错误、数据验证
- [x] 所有单元测试通过，测试数据覆盖各种场景

**验证标准**：数据解析功能正确，错误处理完善，边界情况处理得当

### 3.2 实现数据验证器
- [x] 实现数据验证逻辑，确保数据完整性和合理性
- [x] 实现必填字段验证、数值范围验证、数据类型验证
- [x] 实现异常数据处理和验证错误报告
- [x] 编写单元测试：字段验证、范围验证、类型验证、异常数据、错误报告
- [x] 所有单元测试通过，边界测试用例通过

**验证标准**：数据验证功能完善，错误信息准确，边界处理正确

## 阶段四：主客户端实现

### 4.1 实现 WinPowerClient 主接口
- [x] 实现 `WinPowerClient` 结构体，整合 HTTPClient、TokenManager、DataParser
- [x] 实现 `CollectDeviceData()` 方法的完整流程（检查状态→获取Token→请求数据→解析响应→更新状态）
- [x] 实现分层错误处理和结构化日志记录
- [x] 编写单元测试：完整数据采集流程、认证失败处理、网络错误恢复、数据解析错误、并发访问、性能基准
- [x] 所有单元测试通过，集成测试验证端到端流程

**验证标准**：主客户端功能完整，错误处理健壮，性能指标达标

### 4.2 实现连接状态管理
- [x] 实现连接状态跟踪和健康检查功能
- [x] 实现 `IsHealthy()` 和相关状态查询方法
- [x] 实现状态持久化和恢复机制
- [x] 编写单元测试：连接状态更新、健康检查逻辑、状态持久化、状态查询接口
- [x] 所有单元测试通过，状态监控正确

**验证标准**：连接状态管理准确，健康检查有效，状态信息可靠

## 阶段五：测试和集成

### 5.1 完善单元测试
- [x] 为所有组件编写完整的单元测试，确保覆盖率达到 90% 以上
- [x] 实现测试数据 fixtures（auth_response.json, device_data.json, error_responses.json）
- [x] 实现正常流程、边界条件、错误场景、并发安全的测试覆盖
- [x] 测试覆盖率报告达标（92.6%），所有测试通过

**验证标准**：✅ 单元测试覆盖率 92.6% > 90%，测试用例全面，质量指标达标

### 5.2 Mock 对象实现
- [x] 实现用于测试的 Mock 对象（MockWinPowerClient, MockHTTPClient, MockTokenManager, MockDataParser）
- [x] 支持各种测试场景的配置和控制
- [x] Mock 对象功能完整，测试使用正常

**验证标准**：✅ Mock 对象接口完整，功能可配置，测试便利性良好

## 阶段六：文档和优化

### 6.1 编写模块文档
- [x] 编写完整的模块文档，包括使用指南和 API 文档
- [x] 提供配置示例和集成指南
- [x] 编写故障排除和最佳实践指南
- [x] 文档完整准确，示例代码可运行

**验证标准**：✅ 文档内容完整（README.md 包含 15+ 章节），示例可用，用户能够快速上手

### 6.2 性能优化
- [x] 基于测试结果进行性能优化（连接复用、内存优化、并发优化）
- [x] 实现连接池配置和 Keep-Alive 策略
- [x] 优化内存使用，实现对象复用和内存池
- [x] 性能基准测试达标（单次采集 < 1ms），内存使用稳定

**验证标准**：✅ 性能基准测试通过（318.875µs < 2s），资源使用合理，满足生产环境要求

### 6.3 代码质量检查
- [x] 进行代码静态检查，确保符合项目代码规范
- [x] 运行 `make fmt` 格式化代码
- [x] 运行 `make lint` 进行静态分析，修复所有警告和错误
- [x] `make lint` 通过（0 issues），无警告和错误

**验证标准**：✅ 代码风格一致，静态检查通过，符合 Go 语言最佳实践
