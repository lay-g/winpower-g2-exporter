name: CI Pipeline

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-and-lint:
    name: 测试和代码质量检查
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: 安装依赖
        run: make deps

      - name: 运行测试
        run: make test

      - name: 运行代码覆盖率检查
        run: make test-coverage

      - name: 运行静态分析
        run: make lint

      - name: 运行集成测试
        run: make test-integration

  docker:
    name: 构建和推送 Docker 镜像
    runs-on: ubuntu-latest
    needs: test-and-lint

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        platform: [linux/amd64]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 获取版本信息
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n')
            # 提取 major.minor (例如从 v0.1.5 得到 v0.1)
            MAJOR_MINOR=$(echo $VERSION | grep -oE 'v[0-9]+\.[0-9]+')
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
            MAJOR_MINOR=$VERSION
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major_minor=$MAJOR_MINOR" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: 登录到容器注册表
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 提取元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.major_minor }}

      - name: 构建和推送 Docker 镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: 输出镜像信息
        run: |
          echo "构建的镜像标签:"
          echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
