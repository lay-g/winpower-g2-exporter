# WinPower G2 API 协议文档

## 概述

本文档描述了 WinPower G2 系统的 RESTful API 协议规范，包括认证机制、设备数据查询接口以及相关的数据格式和错误处理。

## 文档结构

- **[认证协议](authentication.md)** - 用户登录和 JWT Token 认证机制
- **[设备数据协议](device-data.md)** - 设备详细信息查询接口

## API 基础信息

### 服务器配置

- **默认端口**: 8081
- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **编码**: UTF-8

### 通用请求头

| Header           | 值                                                | 说明           |
| ---------------- | ------------------------------------------------- | -------------- |
| Accept           | `application/json, text/plain, */*`               | 接受的内容类型 |
| Content-Type     | `application/json`                                | 请求内容类型   |
| Content-language | `en` 或 `zh-CN`                                   | 内容语言       |
| Authorization    | `Bearer {token}`                                  | JWT 认证令牌   |
| User-Agent       | `Mozilla/5.0 (compatible; WinPower-Exporter/1.0)` | 用户代理       |

### 通用响应格式

所有 API 响应都遵循统一的 JSON 格式：

```json
{
    "code": "000000",
    "message": "OK",
    "data": { /* 响应数据 */ }
}
```

**字段说明:**

| 字段名  | 类型         | 说明         |
| ------- | ------------ | ------------ |
| code    | string       | 响应状态码   |
| message | string       | 响应消息     |
| data    | object/array | 响应数据内容 |

### 状态码说明

| 状态码 | 说明                           |
| ------ | ------------------------------ |
| 000000 | 成功                           |
| 其他值 | 错误码，具体含义参考各接口文档 |

## 认证机制

WinPower G2 使用基于 JWT (JSON Web Token) 的认证机制：

1. **登录认证**: 使用用户名和密码获取 JWT Token
2. **Token 使用**: 在后续请求的 Header 中携带 Token
3. **Token 有效期**: 60 分钟，到期后不管是否过期都需要重新登录

详细说明请参考 [认证协议文档](authentication.md)。

## 设备数据接口

提供设备实时数据、配置信息、设置参数等详细信息查询：

- **分页查询**: 支持分页获取设备列表
- **过滤功能**: 支持按区域和设备类型过滤
- **实时数据**: 包含电压、电流、功率、电池状态等实时信息
- **配置信息**: 设备额定参数和配置信息
- **控制功能**: 设备支持的控制操作

详细说明请参考 [设备数据协议文档](device-data.md)。

## 安全考虑

### SSL/TLS 支持

- WinPower 系统通常使用自签名证书
- 客户端可选择跳过 SSL 证书验证
- 生产环境建议配置有效的 SSL 证书

### 认证安全

- Token 应该安全存储，避免泄露
- 建议使用 HTTPS 传输敏感信息
- 定期更新登录密码

### 访问控制

- 遵循最小权限原则
- 限制 API 访问频率
- 监控异常访问行为

## 开发指南

### 环境要求

- HTTP/HTTPS 客户端库
- JSON 解析库
- JWT 解析库（可选）

### 开发步骤

1. **认证登录**: 获取访问 Token
2. **Token 管理**: 缓存和刷新 Token
3. **数据查询**: 调用设备数据接口
4. **错误处理**: 实现适当的错误处理机制
5. **性能优化**: 实现连接池和缓存机制

### 示例项目

参考本项目的 Go 实现：
- 认证管理: `auth.go`
- 数据采集: `collector.go`
- HTTP 客户端: `client.go`

## 故障排除

### 常见问题

1. **认证失败**
   - 检查用户名和密码
   - 确认 Token 是否过期
   - 验证网络连接

2. **SSL 证书错误**
   - 配置跳过 SSL 验证
   - 或添加证书信任

3. **数据格式错误**
   - 检查 JSON 格式
   - 验证字段类型

4. **连接超时**
   - 调整超时设置
   - 检查网络状态

### 调试建议

- 启用详细日志记录
- 注意日志脱敏（不输出用户名、密码、Token、Authorization 头）
- 使用 HTTP 调试工具
- 检查 API 响应状态码
- 验证请求参数格式

## 版本信息

- **API 版本**: v1
- **协议版本**: 1.0
- **文档更新**: 2025-10-13

## 联系信息

如有相关问题或建议，请联系开发团队或查看项目文档。