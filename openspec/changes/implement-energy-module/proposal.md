# implement-energy-module 变更提案

## 概述

本提案旨在实现 WinPower G2 Exporter 的电能计算模块（energy），该模块负责根据设备功率数据计算累计电能消耗，并通过 storage 模块进行持久化存储。

**设计原则**：采用极简单线程架构，通过全局锁确保所有计算操作串行执行，彻底避免并发问题，专注于为UPS设备提供精确的电能累计计算功能。

## Why

### 当前痛点
- **缺失核心功能**：WinPower G2 Exporter 缺少电能计算功能，无法提供累计电能消耗指标
- **监控需求**：用户需要了解UPS设备的长期电能消耗情况，用于成本分析和容量规划
- **架构不完整**：作为数据采集链路的重要环节，energy模块的缺失导致整体架构不完整

### 业务价值
- **能耗监控**：提供精确的设备累计电能数据，支持能耗分析和优化
- **成本管理**：基于电能消耗数据进行电力成本核算和预算管理
- **容量规划**：通过历史电能消耗趋势分析，优化设备配置和扩容决策
- **合规要求**：满足数据中心能耗监控和环保合规要求

### 技术必要性
- **架构完整性**：energy模块是数据采集到指标导出链路的关键环节
- **依赖关系**：后续collector和metrics模块的实现依赖于energy模块提供的计算能力
- **简化维护**：采用极简单线程架构，降低实现复杂度和维护成本

## What Changes

### 新增模块
- **energy-calculator**: 电能计算服务，提供功率到累计电能的转换计算
- **energy-config**: energy模块配置管理，支持计算参数配置

### 新增接口
- **EnergyInterface**: 定义电能计算的标准接口
- **Calculate(deviceID, power)**: 执行电能累计计算
- **Get(deviceID)**: 查询设备累计电能数据

### 新增功能
- **串行计算**: 通过全局锁确保所有计算操作串行执行
- **数据持久化**: 与storage模块集成，确保数据不丢失
- **统计监控**: 提供基础的计算统计信息和日志记录

## 能力范围

### 新增能力
- **energy-calculator**: 实现电能计算服务，提供功率到累计电能的转换计算
- **energy-config**: 定义energy模块的配置结构，支持计算参数配置

### 边界约束
- 仅由collector模块触发计算，不提供定时触发机制
- 完全依赖storage模块进行数据持久化，不直接操作文件系统
- 专注支持UPS设备类型，使用设备总负载有功功率进行计算
- 通过全局锁确保串行执行，避免并发复杂性

## 架构影响

### 模块依赖
- **依赖**: storage模块（已实现）
- **被依赖**: collector模块（后续实现）
- **配置**: 在energy模块内定义Config结构，由config模块统一加载

### 接口设计
```go
type EnergyInterface interface {
    Calculate(deviceID string, power float64) (float64, error)
    Get(deviceID string) (float64, error)
}
```

### 核心组件
- **EnergyService**: 极简单线程架构的电能计算服务
- **全局锁机制**: 确保所有计算操作串行执行
- **简单统计**: 提供基础的计算统计信息

## 实现策略

### 阶段1: 核心接口与结构定义
- 定义EnergyInterface接口和EnergyService结构
- 实现基础的服务构造函数
- 定义energy模块配置结构

### 阶段2: 电能计算核心逻辑
- 实现Calculate方法：功率×时间间隔计算累计电能
- 实现Get方法：从storage读取最新电能数据
- 集成storage模块进行数据读写

### 阶段3: 统计与监控
- 实现简单的计算统计信息
- 添加结构化日志记录
- 提供调试和诊断支持

### 阶段4: 测试与验证
- 编写全面的单元测试
- 进行集成测试验证数据一致性
- 性能测试验证极简架构的有效性

## 验收标准

1. **功能完整性**: 正确实现电能累计计算，支持正负功率
2. **数据一致性**: 通过全局锁确保计算结果的一致性
3. **存储集成**: 与storage模块正确集成，数据持久化可靠
4. **测试覆盖**: 单元测试覆盖率达到90%以上
5. **性能要求**: 对<20个设备，计算延迟<10ms
6. **错误处理**: 优雅处理各种异常情况

## 风险与缓解

### 主要风险
- **性能瓶颈**: 串行执行可能在大规模设备场景下成为瓶颈
- **数据丢失**: 程序异常退出可能导致计算进度丢失

### 缓解措施
- 明确适用场景（<20个设备），在文档中说明性能特点
- 依赖storage模块的原子写入，确保数据持久化
- 提供详细的监控指标和日志，便于问题诊断

## 后续演进

- 如需支持更大规模设备，可考虑实现分片锁或队列机制
- 支持更多设备类型的电能计算模型
- 增加电能数据分析和报告功能