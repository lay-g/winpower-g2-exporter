# 实现日志模块

## 概述

本变更旨在实现基于 zap 的高性能日志模块，提供统一的日志接口和结构化日志输出能力，支持多种日志级别、格式和输出目标，满足 WinPower G2 Exporter 项目的日志需求。

## What Changes

### 新增功能
- 实现完整的 `internal/pkgs/log` 包
- 提供基于 zap 的高性能日志接口
- 支持多种日志级别、格式和输出目标
- 支持上下文感知的日志记录
- 提供全局日志器和便捷函数
- 提供测试专用的日志工具
- 支持日志轮转和文件输出

### 文件变更
- 新增：`internal/pkgs/log/` 整个包目录
- 新增：相关的测试文件
- 更新：项目文档和示例

## Why

根据架构设计文档中的模块依赖顺序 `config → logging → storage → auth → energy → collector → metrics → server → scheduler`，日志模块是第二个核心模块，为其他所有模块提供日志基础设施。当前项目缺乏统一的日志模块，各个模块无法进行有效的日志记录和问题排查。

实现日志模块的必要性：
1. **基础依赖**：日志模块是其他所有模块的基础依赖，需要优先实现
2. **问题排查**：统一的日志记录对于系统监控和故障排查至关重要
3. **性能监控**：高性能的日志模块可以最小化对系统性能的影响
4. **开发效率**：统一的日志接口可以提高开发效率和代码一致性
5. **运维支持**：结构化日志便于日志分析和监控系统集成

## 背景

当前项目缺乏统一的日志模块，各个模块无法进行有效的日志记录和问题排查。根据架构设计文档中的模块依赖顺序 `config → logging → storage → auth → energy → collector → metrics → server → scheduler`，日志模块是第二个核心模块，为其他所有模块提供日志基础设施。

现有设计文档 `docs/design/logging.md` 已经详细定义了日志模块的完整设计，包括：
- 基于 zap 的高性能日志库
- 结构化日志支持
- 多级别日志（Debug, Info, Warn, Error）
- 多种输出格式（JSON, Console）
- 多种输出目标（Stdout, Stderr, File）
- 日志轮转和归档
- 上下文日志支持
- 全局日志器
- 测试专用日志器

## 目标

1. **实现核心日志接口**：基于 zap 实现 Logger 接口，提供类型安全的日志方法
2. **支持多种配置**：支持日志级别、格式、输出目标的灵活配置
3. **高性能**：利用 zap 的零内存分配特性，最小化性能开销
4. **易用性**：提供简洁的 API 和全局日志函数
5. **测试支持**：提供测试专用的日志器和日志捕获工具
6. **上下文感知**：支持从 context 自动提取追踪信息

## 范围

### 包含内容
- 实现 `internal/pkgs/log` 包的完整功能
- 日志配置结构和默认值
- Logger 接口和 zap 实现
- 全局日志器管理
- 上下文日志支持
- 测试专用日志器
- 日志轮转和文件输出
- 编码器配置（JSON/Console）
- 完整的单元测试

### 不包含内容
- 日志聚合和分析系统
- 远程日志服务集成
- 日志查询 API
- 图形化日志管理界面

## 设计

### 架构概览
```
┌─────────────────────────────────────────────────┐
│                 Application                     │
└────────────────────┬────────────────────────────┘
                     │ log.Info()
                     ▼
┌─────────────────────────────────────────────────┐
│              Logger Interface                   │
│  ┌───────────────────────────────────────────┐  │
│  │  - Debug(msg, fields...)                  │  │
│  │  - Info(msg, fields...)                   │  │
│  │  - Warn(msg, fields...)                   │  │
│  │  - Error(msg, fields...)                  │  │
│  │  - With(fields...) Logger                 │  │
│  └───────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│              Zap Logger Core                    │
│  ┌───────────────┬──────────────┬────────────┐  │
│  │   Encoder     │    Writer    │   Level    │  │
│  │  (JSON/Console) │ (File/Stdout)│ (Info/Debug)│ │
│  └───────────────┴──────────────┴────────────┘  │
└─────────────────────────────────────────────────┘
```

### 核心组件

1. **配置管理** (`config.go`)
   - 日志配置结构
   - 默认配置值
   - 配置验证

2. **日志接口** (`logger.go`)
   - Logger 接口定义
   - zap 实现
   - 字段构造函数

3. **编码器配置** (`encoder.go`)
   - JSON 编码器
   - Console 编码器
   - 时间和级别格式化

4. **输出管理** (`writer.go`)
   - 标准输出/错误输出
   - 文件输出
   - 日志轮转

5. **上下文支持** (`context.go`)
   - 上下文字段提取
   - 上下文日志器管理

## 影响评估

### 依赖关系
- **输入依赖**：config 模块（日志配置）
- **输出依赖**：被其他所有模块依赖（storage, auth, energy, collector, metrics, server, scheduler）

### 兼容性
- 纯新增功能，不影响现有代码
- 向后兼容，支持后续扩展

### 性能影响
- 基于 zap 的高性能实现，零内存分配
- 对系统性能影响极小
- 支持异步日志写入

## 风险分析

### 技术风险
- **低风险**：zap 是成熟稳定的日志库，广泛使用
- **配置复杂性**：通过提供合理的默认值降低配置复杂度

### 运维风险
- **日志量管理**：通过日志级别控制和采样机制管理日志量
- **存储空间**：通过日志轮转和压缩控制存储使用

## 成功标准

1. ✅ 日志模块所有核心功能正常工作
2. ✅ 单元测试覆盖率达到 90% 以上
3. ✅ 性能测试满足要求（支持高并发日志写入）
4. ✅ 支持所有设计文档中定义的配置选项
5. ✅ 与其他模块集成测试通过
6. ✅ 文档完整，包含使用示例

## 实施计划

详细的实施步骤请参考 `tasks.md` 文件。

## 验收标准

1. **功能验收**：
   - 支持多种日志级别和格式
   - 支持文件输出和轮转
   - 支持上下文日志
   - 测试工具完整可用

2. **性能验收**：
   - 支持高并发日志写入
   - 内存使用高效
   - CPU 开销最小

3. **质量验收**：
   - 代码质量符合项目规范
   - 测试覆盖率达标
   - 文档完整准确